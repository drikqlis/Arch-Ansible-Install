---

- name: Ensure packages and cache are updated
  community.general.pacman:
    update_cache: true
    upgrade: true

- name: Ensure packages are installed
  community.general.pacman:
    name:
      - pacman-contrib
      - reflector
    state: present

- name: Ensure paccache timer is enabled and started
  ansible.builtin.systemd:
    name: paccache.timer
    enabled: true
    state: started

- name: Ensure paccache.service.d directory exists
  ansible.builtin.file:
    path: /etc/systemd/system/paccache.service.d/
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure paccache.service override exists
  ansible.builtin.copy:
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/paccache -rk1 ; /usr/bin/paccache -ruk0
    dest: /etc/systemd/system/paccache.service.d/override.conf
    owner: root
    group: root
    mode: "0644"
  notify: Daemon reload

- name: Ensure pacman config is correct
  ansible.builtin.lineinfile:
    dest: /etc/pacman.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: "^#?.?CleanMethod", line: "CleanMethod = KeepCurrent" }
    - { regexp: "^#?.?ParallelDownloads", line: "ParallelDownloads = 5" }
    - { regexp: "^#?.?Color", line: "Color" }

- name: Ensure arch.drik.it repo is added
  ansible.builtin.blockinfile:
    path: /etc/pacman.conf
    insertafter: EOF
    block: |
      # Modified by Arch-Ansible-Install
      # Author Drik.IT
      [aur]
      SigLevel = Optional TrustAll
      Server = https://arch.drik.it

- name: Ensure reflector config is correct
  ansible.builtin.lineinfile:
    dest: /etc/xdg/reflector/reflector.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: "^#?.?--country", line: "--country Poland,Germany,France" }
    - { regexp: "^#?.?--sort", line: "--sort rate" }

- name: Ensure reflector timer is enabled and started
  ansible.builtin.systemd:
    name: reflector.timer
    enabled: true
    state: started
  notify: Run reflector
