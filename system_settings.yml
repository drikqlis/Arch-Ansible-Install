---
# Configuring system settings
# --------------------------------------------------------------------

- name: Ensure system settings are configured
  hosts: archinstalled

  tasks:

    # Globals
    # --------------------------------------------------------------------

    - name: Set kdeglobals (global theme, single click, file dialog)
      copy:
        src: files/kde/kdeglobals
        dest: /home/{{ user_name }}/.config/kdeglobals

    - name: Set kwinrc (disable border buttons, borderless maximized, meta shortcut to krunner, night color)
      copy:
        src: files/kde/kwinrc
        dest: /home/{{ user_name }}/.config/kwinrc

    - name: Set khotkeysrc (type-clip, system monitor)
      copy:
        src: files/kde/khotkeysrc
        dest: /home/{{ user_name }}/.config/khotkeysrc

    # Delete junk home folders
    # --------------------------------------------------------------------

    - name: Delete junk home folders
      file:
        path: /home/{{ user_name }}/{{ item }}
        state: absent
      loop:
        - Videos
        - Music
        - Pictures
        - Templates
        - Public
        - Wideo
        - Muzyka
        - Obrazy
        - Szablony
        - Publiczne

    # Dolphin
    # --------------------------------------------------------------------

    - name: Set dolphinrc (dolphin settings)
      copy:
        src: files/kde/dolphinrc
        dest: /home/{{ user_name }}/.config/dolphinrc

    - name: Set view mode to details in dolphin
      copy:
        src: files/kde/directory
        dest: /home/{{ user_name }}/.local/share/dolphin/view_properties/global/.directory

    - name: Hide unused items in places (dolphin)
      xml:
        path: /home/{{ user_name }}/.local/share/user-places.xbel
        xpath: "{{ item }}"
        value: "true"
      loop:
        - /xbel/info/metadata/GroupState-RecentlySaved-IsHidden
        - /xbel/info/metadata/GroupState-SearchFor-IsHidden

    - name: Delete junk folders from places
      xml:
        path: /home/{{ user_name }}/.local/share/user-places.xbel
        xpath: "{{ item }}"
        state: absent
      loop:
        - /xbel/bookmark[title='Music']
        - /xbel/bookmark[title='Pictures']
        - /xbel/bookmark[title='Videos']
        - /xbel/bookmark[title='Muzyka']
        - /xbel/bookmark[title='Obrazy']
        - /xbel/bookmark[title='Wideo']

    - name: Hide duplicate disk in places
      xml:
        path: /home/{{ user_name }}/.local/share/user-places.xbel
        xpath: /xbel/separator/info/metadata[UDI='/org/freedesktop/UDisks2/block_devices/dm_2d0']/IsHidden
        value: "true"

    # Kate
    # --------------------------------------------------------------------

    - name: Set katerc (kate settings)
      copy:
        src: files/kde/katerc
        dest: /home/{{ user_name }}/.config/katerc

    - name: Make sure sessions directory exists
      file:
        path: /home/{{ user_name }}/.local/share/kate/sessions
        state: directory
        recurse: yes

    - name: Set kate session
      copy:
        src: files/kde/Notepad.katesession
        dest: /home/{{ user_name }}/.local/share/kate/sessions/Notepad.katesession

    - name: Always start Notepad session
      lineinfile:
        dest: /home/{{ user_name }}/.local/share/applications/org.kde.kate.desktop
        regexp: Exec=kate -b %U
        line: Exec=kate -b %U --start Notepad
        backrefs: yes

    # Konsole
    # --------------------------------------------------------------------

    - name: Set konsolerc (konsole settings)
      copy:
        src: files/kde/konsolerc
        dest: /home/{{ user_name }}/.config/konsolerc

    # Okular
    # --------------------------------------------------------------------

    - name: Set okularrc (okular settings)
      copy:
        src: files/kde/okularrc
        dest: /home/{{ user_name }}/.config/okularrc

    - name: Set okularpartrc (okular settings)
      copy:
        src: files/kde/okularpartrc
        dest: /home/{{ user_name }}/.config/okularpartrc

    # Gwenview
    # --------------------------------------------------------------------

    - name: Set gwenviewrc (gwenview settings)
      copy:
        src: files/kde/gwenviewrc
        dest: /home/{{ user_name }}/.config/gwenviewrc

    # Spectacle
    # --------------------------------------------------------------------

    - name: Set spectaclerc (spectacle settings)
      template:
        src: files/kde/spectaclerc.j2
        dest: /home/{{ user_name }}/.config/spectaclerc

    - name: Change spectacle shortcuts
      lineinfile:
        dest: /home/{{ user_name }}/.config/kglobalshortcutsrc
        regexp: "{{ item.regex }}"
        line: "{{ item.line }}"
        backrefs: yes
      loop:
        - {regex: "RectangularRegionScreenShot=", line: "RectangularRegionScreenShot=Meta+Shift+S,Meta+Shift+Print,Capture Rectangular Region"}
        - {regex: "WindowUnderCursorScreenShot=", line: "WindowUnderCursorScreenShot=Meta+Ctrl+S,Meta+Ctrl+Print,Capture Window Under Cursor"}
